services:
  db:
    image: mongo:8.0

  app:
    build:
      context: ../
      dockerfile: .devcontainer/Dockerfile
    command: sleep infinity
    depends_on:
      - db
    ports:
      - "3002:3002"
      - "4002:4002"
    environment:
      - MONGO_DB_HOST=db
      # Forward SSH agent for git operations (Unix systems)
      - SSH_AUTH_SOCK=${SSH_AUTH_SOCK:-}
    volumes:
      # Main workspace mount
      - ..:/workspace
      
      # Exclude node_modules and dist folders from sync for performance
      - /workspace/node_modules
      - /workspace/apps/frontend/dist
      - /workspace/apps/backend/dist
      
      # Git credential forwarding (conditional mounts based on platform)
      # These mounts will only work if the source files exist
      - type: bind
        source: ${HOME:-${USERPROFILE}}/.git-credentials
        target: /home/node/.git-credentials
        read_only: true
        consistency: cached
        bind:
          create_host_path: true
      
      # SSH key forwarding for git operations
      - type: bind
        source: ${HOME:-${USERPROFILE}}/.ssh
        target: /home/node/.ssh
        read_only: true
        consistency: cached
        bind:
          create_host_path: true
      
      # SSH agent socket forwarding (Unix systems only)
      # This will be ignored on Windows
      - type: bind
        source: ${SSH_AUTH_SOCK:-/tmp/ssh-agent-fallback}
        target: ${SSH_AUTH_SOCK:-/tmp/ssh-agent-fallback}
        consistency: cached
        bind:
          create_host_path: false